name: Deploy Demo Nginx App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod-blue
        - prod-green

env:
  DEPLOY_TIME: ${{ github.event.head_commit.timestamp || github.run_id }}
  GIT_COMMIT: ${{ github.sha }}

jobs:
  deploy:
    runs-on: [self-hosted, local]
    
    strategy:
      matrix:
        environment: 
          - ${{ github.event.inputs.environment || (github.event_name == 'pull_request' && 'dev' || 'prod-blue') }}
    
    steps:
    - name: ğŸ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Display deployment info
      run: |
        echo "ğŸš€ Deploying to environment: ${{ matrix.environment }}"
        echo "ğŸ“¦ Git commit: ${{ env.GIT_COMMIT }}"
        echo "ğŸ• Deploy time: ${{ env.DEPLOY_TIME }}"
        echo "ğŸƒâ€â™‚ï¸ Triggered by: ${{ github.event_name }}"
        echo "ğŸŒ Runner hostname: $(hostname)"
        
    - name: ğŸ§¹ Cleanup existing deployment
      run: |
        echo "ğŸ§¹ Cleaning up existing containers for ${{ matrix.environment }}..."
        docker-compose -p demo-${{ matrix.environment }} down --remove-orphans || true
        docker system prune -f || true
        
    - name: ğŸ—ï¸ Build and deploy
      run: |
        echo "ğŸ—ï¸ Building and deploying to ${{ matrix.environment }}..."
        
        # Set environment variables
        export DEPLOY_TIME="${{ env.DEPLOY_TIME }}"
        export GIT_COMMIT="${{ env.GIT_COMMIT }}"
        export APP_VERSION="${{ github.ref_name }}-${{ github.run_number }}"
        
        # Load environment-specific variables
        if [ -f ".env.${{ matrix.environment }}" ]; then
          set -a
          source .env.${{ matrix.environment }}
          set +a
          echo "âœ… Loaded environment file: .env.${{ matrix.environment }}"
        else
          echo "âš ï¸ Environment file .env.${{ matrix.environment }} not found, using defaults"
        fi
        
        # Determine compose files to use
        COMPOSE_FILES="-f docker-compose.yml"
        if [ -f "docker-compose.${{ matrix.environment }}.yml" ]; then
          COMPOSE_FILES="$COMPOSE_FILES -f docker-compose.${{ matrix.environment }}.yml"
          echo "âœ… Using override file: docker-compose.${{ matrix.environment }}.yml"
        fi
        
        # Deploy with compose
        docker-compose $COMPOSE_FILES -p demo-${{ matrix.environment }} up -d --build
        
    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Wait for container to be ready
        sleep 10
        
        # Get container info
        docker-compose -p demo-${{ matrix.environment }} ps
        
        # Get the port from environment or default
        if [ -f ".env.${{ matrix.environment }}" ]; then
          source .env.${{ matrix.environment }}
        fi
        PORT=${NGINX_PORT:-8080}
        
        # Test health endpoint
        echo "ğŸ¥ Testing health endpoint..."
        curl -f http://localhost:$PORT/health || (echo "âŒ Health check failed" && exit 1)
        
        # Test info endpoint
        echo "ğŸ“‹ Testing info endpoint..."
        curl -f http://localhost:$PORT/info || (echo "âŒ Info endpoint failed" && exit 1)
        
        echo "âœ… Deployment verification successful!"
        echo "ğŸŒ Application available at: http://localhost:$PORT"
        
    - name: ğŸ·ï¸ Tag successful deployment
      if: success() && github.event_name == 'push'
      run: |
        echo "ğŸ·ï¸ Tagging successful deployment..."
        
        # Create deployment tag
        DEPLOYMENT_TAG="deploy-${{ matrix.environment }}-$(date +%Y%m%d-%H%M%S)"
        
        # Log deployment details
        echo "ğŸ“ Deployment Details:" >> deployment.log
        echo "Environment: ${{ matrix.environment }}" >> deployment.log
        echo "Commit: ${{ env.GIT_COMMIT }}" >> deployment.log
        echo "Time: ${{ env.DEPLOY_TIME }}" >> deployment.log
        echo "Tag: $DEPLOYMENT_TAG" >> deployment.log
        echo "Runner: $(hostname)" >> deployment.log
        echo "---" >> deployment.log
        
        echo "âœ… Deployment tagged as: $DEPLOYMENT_TAG"
        
    - name: ğŸ“Š Deployment summary
      if: always()
      run: |
        echo "ğŸ“Š Deployment Summary"
        echo "===================="
        echo "Environment: ${{ matrix.environment }}"
        echo "Status: ${{ job.status }}"
        echo "Commit: ${{ env.GIT_COMMIT }}"
        echo "Time: ${{ env.DEPLOY_TIME }}"
        echo "Runner: $(hostname)"
        
        if [ "${{ job.status }}" = "success" ]; then
          if [ -f ".env.${{ matrix.environment }}" ]; then
            source .env.${{ matrix.environment }}
          fi
          PORT=${NGINX_PORT:-8080}
          echo "ğŸŒ Access your app: http://localhost:$PORT"
          echo "ğŸ¥ Health check: http://localhost:$PORT/health"
          echo "ğŸ“‹ Info endpoint: http://localhost:$PORT/info"
        fi
